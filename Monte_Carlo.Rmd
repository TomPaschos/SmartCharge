---
title: "Monte Carlo Simulation"
author: "Danny Ettelson"
date: "1/21/2019"
output:
  pdf_document: default
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loadlib}
library(tidyverse)
library(dplyr)
library(RColorBrewer)
library(lubridate)
```



CONTEXT



```{r loadlib, message=FALSE, warning=FALSE}

source("hourly_demand_function.R")


#hourly_demand()

#test <- hourly_demand(method = 2, ....)

```



SIMULATION



```{r simulation}


simulation <- function(simulations = 1000, 
                       sim_method = mthd,
                       sim_avg_elasticity = avg_elst,
                       sim_seg = sg,
                       sim_month = mth, #baseline month
                       sim_year = yr, #baseline year
                       sim_include_wknds = wknds,
                       sim_charger_power = pwr,
                       sim_elasticity_schedule = sch, 
                       sim_price_change = p_c, 
                       sim_intervention_hours = i_h,
                       sim_intervention_chargers = int_ch, 
                       sim_int_equals_baseline = int_e_b, 
                       sim_throttle_amount = t_a, 
                       sim_throttle_hours = t_h,
                       sim_air_pollution_comm = a_p_co,
                       sim_price_comm = p_co,
                       sim_curt_year=c_yr,
                       sim_new_tou = n_tou) {

  ##create lists to sample from for each variable to sample from
  #method
  method_draws <- sample(c(1:4), simulations, replace = TRUE)
  
  #self and cross elasticities 
  #eliminate cross elasticities from 0 to 1
   if(sim_method == 1) {
    Elasticities <- Elasticities_cross
  } else{
    Elasticities <- Elasticities_no_cross
  }
  
   if(sim_include_wknds == TRUE) {
    Elasticities <- Elasticities
  } else {
    Elasticities <- Elasticities[1:8] # filters for first 6 elasticities (first two columsn are hour and period)
  }

  elasticity_draws <- sample(3:length(Elasticities),simulations,replace = TRUE)
  
  #average elasticty 
  avg_elasticity_possibilities <- seq(from = -0.8, to = -0.04, by = 0.01)
  avg_elasticity_draws <- sample(avg_elasticity_possibilities, simulations, replace = TRUE)
  
  #comm (not set to be a sample, but could be)
  comm_possibilities <- seq(from=0.2, to=1, by=.01)
  comm_draws <-  sample(comm_possibilities,simulations, replace = TRUE)

  #create empty data frame for simulation fcn to populate
  sim_result <- hourly_demand()
  sim_result_EV_Demand <- sim_result$EV_Demand %>% 
    mutate(method_draw = 0, elasticity_draw = 0) %>% 
      mutate(avg_elasticity_draw = 0)
  sim_result_EV_Demand <- sim_result_EV_Demand[0,]


  for(i in seq(simulations)){
    run_i <- hourly_demand(method = method_draws[i],
                       avg_elasticity = avg_elasticity_draws[i],
                       seg = sim_seg,
                       month = sim_month, 
                       year = sim_year,
                       include_wknds = sim_include_wknds,
                       charger_power = sim_charger_power,
                       elasticity_schedule = elasticity_draws[i], 
                       price_change = sim_price_change, 
                       intervention_hours = sim_intervention_hours,
                       intervention_chargers = sim_intervention_chargers, 
                       int_equals_baseline = sim_int_equals_baseline, 
                       throttle_amount = sim_throttle_amount, 
                       throttle_hours = sim_throttle_hours,
                       air_pollution_comm = sim_air_pollution_comm,
                       price_comm = sim_price_comm,
                       curt_year=sim_curt_year,
                       new_tou=sim_new_tou)

    
    run_i_EV_Demand <- run_i$EV_Demand %>% 
      mutate(method_draw = method_draws[i], elasticity_draw = elasticity_draws[i]) %>% 
      mutate(avg_elasticity_draw = elasticity_draws[i])
  
    sim_result_EV_Demand <- rbind(sim_result_EV_Demand,run_i_EV_Demand)
  
  
  }

      sim_result_summary <- group_by(sim_result_EV_Demand, Hr) %>% 
    summarise_at(vars(Xf, P0, Xi, X0, P1, X1, Xint_effect, Xf, Curt, I01),funs(mean,min,max))
      
      names(sim_result_summary[-1]) <- "NULL" #to avoid a dumb error

  
  return(list(sim_result_EV_Demand = sim_result_EV_Demand, sim_result_summary = sim_result_summary))
}


#sim1 <- simulation()
```

Chunk below takes a LONG TIME to run

```{r simulation_aggregation}


sim_agg <- data.frame(month = rep(1:12, each = 4), segment = rep(c("Workplace", "Multi Unit Dwelling", "Fleet", "Destination Center"),12))

summer_i_h <- c(12:15) #option 1
winter_i_h <- c(17:21) #option 2

sim_agg <- sim_agg %>% 
  mutate(price_change = ifelse(month %in% c(6:9),-0.05,0.1), intervention_hours = (ifelse(month %in% c(6:9), 1, 2)))

sim_annual_aggregated <- data.frame()


for (i in seq(1,48,1)) {
  
  sim_i <- simulation(simulations = 10,
             sim_price_change = sim_agg$price_change[i],
             sim_seg = sim_agg$segment[i],
             sim_intervention_hours = ifelse(sim_agg$intervention_hours[i] == 1, summer_i_h, winter_i_h),
             sim_month = sim_agg$month[i])
  
  
  sim_i_summary <- sim_i$sim_result_EV_Demand %>% 
    mutate(price_change = sim_agg$price_change[i], segmnt = sim_agg$segment[i], int_hrs =  sim_agg$intervention_hours[i], sim_month  = sim_agg$month[i])
  
  sim_annual_aggregated <- rbind(sim_annual_aggregated, sim_i_summary)
  
}


```

EMISSIONS + ALL OUTPUTS



```{r emissions_outputs}

#Load default periods (intervention hour is set above); decide if moving these defaults above; and default year
pk <- c(17:21) #target window to shift out off (this is only used in the output calculations below, not for the function)
yr <- 2018 # only real options are 2030 or 2018. if you pick anything else it defualts to 2018. 

#Insert costs ($/kg)
NOXcost <- 21.93 #$/kg
Curtailmentcost <- 0.15 #$/MWH
CO2cost <-0.05 #$/kg

#emissions_x <- emission_output(run_x$EV_Demand)
# emissions_x<- emission_output(hourly_demand()) 
# Emissionfcn <- function (EV_Demand_run1, peak_hour = pk) {
# add a column to output of hourly demand that specifies intervention hours (binary 1: 0; intervention hours = 1; not = 0); read that in for intervention hour; read in peak hours as another input; then calculate everything else other hour of concern (peak), and other
#}

emissions_fcn <- function(EVDemand, peak_hours = pk, emissions_year = yr) {

#Load emissiosn factors  based on year
   # Elasticity 
  if(emissions_year == 2030) {
    Hourly_EF <- read_csv("Hrly_EF_2030.csv")
  } else{
   Hourly_EF <- read_csv("Hrly_EF_2018.csv")
  }
  
#Create Date Frame for Emissions Outputs
Emissions <- data.frame(Hr = c(1:24)) %>% 
  mutate(CO2Baseline=Hourly_EF$CO2Baseline) %>% 
  mutate(CO2Marginal=Hourly_EF$CO2Marginal_gas) %>% 
  mutate(NOXBaseline=Hourly_EF$NOXBaseline) %>% 
  mutate(NOXMarginal=Hourly_EF$NOXMarginal_gas) %>% #want to change this so it selects the baseline and marginal based on year input and the gas/no gas scenario automatically in the function
  mutate(PercSolar=Hourly_EF$SolarPerc) %>% 
  mutate(I01 = EVDemand$sim_result_summary$I01_mean) %>% 
  mutate(Xi = EVDemand$sim_result_summary$Xi_mean) %>% # column for initial demand at each hour not scaled
  mutate(X0 = EVDemand$sim_result_summary$X0_mean) %>% # column for initial demand at each hour scaled by chargers
  mutate(Xf = EVDemand$sim_result_summary$Xf_mean) %>% 
  mutate(curt = EVDemand$sim_result_summary$Curt_mean) %>% 
  mutate(Xdelta = EVDemand$sim_result_summary$Xint_effect_mean) %>% 
     # column for new demand at each hour. we'll need to update "Xt" to reflect the new column post comms/all interventions
  mutate(Pbase = EVDemand$sim_result_summary$P0_mean*EVDemand$sim_result_summary$X0_mean) %>% #total price paid in that hour ($/kwh * kwh)
  mutate(Pnew = EVDemand$sim_result_summary$P1_mean*EVDemand$sim_result_summary$Xf_mean) #total price paid in that hour ($/kwh * kwh)

Emissions <- Emissions %>% 
  mutate(Xcurtpot = Xdelta*PercSolar) 

Emissions <- Emissions %>% 
  mutate(Xcurt = ifelse(Xcurtpot<curt,ifelse(curt == 0,0,Xcurtpot),curt)) %>% #sum and run percentages on Xcurt 
  mutate(Xextra = ifelse(Xcurtpot>curt, ifelse(Xcurt-Xcurtpot< 0,0, Xcurt-Xcurtpot),0))

#Calculate emissions for baseline demand (scaled and not)
Emissions <- Emissions %>%
  #mutate (CO2Xi = Xi*CO2Baseline) %>% 
  #mutate (NOXXi = Xi*NOXBaseline) %>% 
  mutate (CO2X0 = X0*CO2Baseline) %>% 
  mutate (NOXX0 = X0*NOXBaseline)

#calculate change in emissions
Emissions <- Emissions %>%
  mutate (CO2Xdelta = Xdelta*CO2Marginal) %>% 
  mutate (NOXXdelta= Xdelta*NOXMarginal)

#calculate emissions for final
Emissions <- Emissions %>%
  mutate (CO2Xf = CO2X0+CO2Xdelta) %>% # baseline emissions - change for emissions associated with final demand
  mutate (NOXXf = NOXX0+NOXXdelta)

#Set intervention hours, peak hours, other hours based on intervention hours selected for hourly demand fcn and peak hours input above. 
#Find interventions hours
intervention_emission_hours <- which(Emissions[,7] == 1) #pulls intervention hours from initial hourly demand fcn
#Find other hours based on intervention hours set in hourly function and peak hour input
other_emission_hours <- c(1:24) #create 1:24 for all other hours
other_emission_hours <-other_emission_hours[!other_emission_hours %in% intervention_emission_hours] #remove the intervention hours
other_emission_hours <-other_emission_hours[!other_emission_hours %in% peak_hours] #remove the pk hours

## Final summations
# sum baseload by period
 X0_i_h <- sum(Emissions$X0[intervention_emission_hours]) 
 X0_pk <- sum(Emissions$X0[peak_hours]) 
 X0_o_h <- sum(Emissions$X0[other_emission_hours]) 
 X0_sum <- sum(Emissions$X0)
 
# sum final load by period
  Xf_i_h <- sum(Emissions$Xf[intervention_emission_hours]) 
  Xf_pk <- sum(Emissions$Xf[peak_hours]) 
  Xf_o_h <- sum(Emissions$Xf[other_emission_hours]) 
  Xf_sum <- sum(Emissions$Xf)
 
# sum intervention change by period
 Xdelta_i_h <- sum(Emissions$Xdelta[intervention_emission_hours]) 
 Xdelta_pk <- sum(Emissions$Xdelta[peak_hours]) 
 Xdelta_o_h <- sum(Emissions$Xdelta[other_emission_hours]) 
 Xdelta_sum <- sum(Emissions$Xdelta)

# sum baseline cost by period
 P0_i_h <- sum(Emissions$Pbase[intervention_emission_hours]) 
 P0_pk <- sum(Emissions$Pbase[peak_hours]) 
 P0_o_h <- sum(Emissions$Pbase[other_emission_hours]) 
 P0_sum <- sum(Emissions$Pbase)
 
# sum final cost by period
 Pf_i_h <- sum(Emissions$Pnew[intervention_emission_hours]) 
 Pf_pk <- sum(Emissions$Pnew[peak_hours]) 
 Pf_o_h <- sum(Emissions$Pnew[other_emission_hours]) 
 Pf_sum <- sum(Emissions$Pnew)

# sum change in cost by period
 Pdelta_i_h <- Pf_i_h - P0_i_h 
 Pdelta_pk <- Pf_pk - P0_pk
 Pdelta_o_h <- Pf_o_h - P0_o_h
 Pdelta_sum <- Pf_sum - P0_sum
 
#Sum base emissions by period (intervention window, peak window, other)
 CO2X0_i_h <- sum(Emissions$CO2X0[intervention_emission_hours]) 
 CO2X0_pk <- sum(Emissions$CO2X0[peak_hours]) 
 CO2X0_o_h <- sum(Emissions$CO2X0[other_emission_hours]) 
 CO2X0_sum <- sum(Emissions$CO2X0)
 NOXX0_i_h <- sum(Emissions$NOXX0[intervention_emission_hours])
 NOXX0_pk <- sum(Emissions$NOXX0[peak_hours])
 NOXX0_o_h <- sum(Emissions$NOXX0[other_emission_hours]) 
 NOXX0_sum <- sum(Emissions$NOXX0)
 
#Sum final emissions by period (intervention window, peak window, other)
 CO2Xf_i_h <- sum(Emissions$CO2Xf[intervention_emission_hours]) #11-3 window
 CO2Xf_pk <- sum(Emissions$CO2Xf[peak_hours]) #peak 4pm-9pm window
 CO2Xf_o_h <- sum(Emissions$CO2Xf[other_emission_hours]) #all other hours
 CO2Xf_sum <- sum(Emissions$CO2Xf)
 NOXXf_i_h <- sum(Emissions$NOXXf[intervention_emission_hours]) #11-3 window
 NOXXf_pk <- sum(Emissions$NOXXf[peak_hours]) #peak 4pm-9pm window
 NOXXf_o_h <- sum(Emissions$NOXXf[other_emission_hours]) #all other hours
 NOXXf_sum <- sum(Emissions$NOXXf)
 
#Sum change in emissions by period (intervention window, peak window, other)
 CO2Xdelta_i_h <- sum(Emissions$CO2Xdelta[intervention_emission_hours]) #11-3 window
 CO2Xdelta_pk <- sum(Emissions$CO2Xdelta[peak_hours]) #peak 4pm-9pm window
 CO2Xdelta_o_h <- sum(Emissions$CO2Xdelta[other_emission_hours]) #all other hours
 CO2Xdelta_sum <- sum(Emissions$CO2Xdelta)
 NOXXdelta_i_h <- sum(Emissions$NOXXdelta[intervention_emission_hours]) #11-3 window
 NOXXdelta_pk <- sum(Emissions$NOXXdelta[peak_hours]) #peak 4pm-9pm window
 NOXXdelta_o_h <- sum(Emissions$NOXXdelta[other_emission_hours]) #all other hours
 NOXXdelta_sum <- sum(Emissions$NOXXdelta)

#Calculate NOx impacts in DACs vs not (assuming peaker DACs account for 25% of load, even though they account for 70% of plants)
 NOxDACXdelta_i_h <- 0
 NOxDACXdelta_pk <- NOXXdelta_pk*.25 *.70
 NOxDACXdelta_o_h <- 0
 NOxDACXdelta_sum <- NOxDACXdelta_pk
 
 
#Put into new df
Emissions_Table <- data.frame(Time= c("intervention hours", "peak period", "other", "Total"), Xinitial = c(X0_i_h, X0_pk, X0_o_h, X0_sum), Xfinal = c(Xf_i_h, Xf_pk, Xf_o_h, Xf_sum), Xchange = c(Xdelta_i_h, Xdelta_pk, Xdelta_o_h, Xdelta_sum), CustCostInitial = c(P0_i_h, P0_pk, P0_o_h, P0_sum), CustCostFinal = c(Pf_i_h, Pf_pk, Pf_o_h, Pf_sum), CustCostChange = c(Pdelta_i_h, Pdelta_pk, Pdelta_o_h, Pdelta_sum), CO2Initial = c(CO2X0_i_h, CO2X0_pk, CO2X0_o_h, CO2X0_sum), CO2Final = c(CO2Xf_i_h, CO2Xf_pk, CO2Xf_o_h, CO2Xf_sum), CO2Change = c(CO2Xdelta_i_h, CO2Xdelta_pk, CO2Xdelta_o_h, CO2Xdelta_sum), NOXInitial = c(NOXX0_i_h, NOXX0_pk, NOXX0_o_h, NOXX0_sum), NOXFinal = c(NOXXf_i_h, NOXXf_pk, NOXXf_o_h, NOXXf_sum), NOXChange = c(NOXXdelta_i_h, NOXXdelta_pk, NOXXdelta_o_h, NOXXdelta_sum), NOXChangeDAC = c(0, NOxDACXdelta_pk, 0, 0))
#Note: there's got to be a cleaner way to calculate these totals.  

#Calculate cost reduction from NOX reduction (only doing it for the change)
Emissions_Table <- Emissions_Table %>% 
  mutate(NOXChangeCost = NOXChange*NOXcost) %>% #this is in dollars
  mutate(CO2ChangeCost = CO2Change*CO2cost)
 
#Curtailment Cost Reduction
Xcurtpotential <- sum(Emissions$Xcurt) #eek. this 75% is weird and doesn't match the solar fuel mix %. we need another column for solar reduction potential in the fuel mix. 
Xcurtextra <- sum(Emissions$Xextra) 
Xcurtproportion <- Xcurtpotential/sum(Emissions$curt)

Curtailmentcost <- Xcurtpotential*-Curtailmentcost
#add to output table
Emissions_Table <- Emissions_Table %>% 
   mutate(RedCurtProp = c("NA", "NA", "NA", Xcurtproportion), SolarNonCurt= c("NA", "NA", "NA", Xcurtextra), ChangeCurtCost = c("NA", "NA", "NA", Curtailmentcost))

return(list(Emissions=Emissions, Emissions_Table=Emissions_Table))
}

#Test_emissions <- emissions_fcn(sim1) or Test_emissions <- emissions_fcn(EVDemand = simulation())

#defaults below
#emissions_fcn defaults. peak_hours 17:21 and emissions year 2018. only change if need to make 2030 run. Then: emissions_year = 2030. Always run on the output from your simulation table. see example below with defaults. #PM1_output_table <- emissions_fcn(PM1) to run defaults
#PM1_output_table <- emissions_fcn(EVDemand = PM1, peak_hours = c(17:21), emissions_year = 2019)

```

#WORKPLACES 

```{r workplace_scenarios, message=FALSE, warning=FALSE}

#PW1S = discount + price comm + morning throttling
PW1S <- simulation(simulations = 1000, sim_seg = "Workplace",
                       sim_month = 7, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_throttle_amount = -0.5, 
                       sim_throttle_hours = c(7:11),
                       sim_air_pollution_comm = FALSE, #no comm
                       sim_price_comm = TRUE, #yes comm
                       sim_curt_year=2018)

write_csv(PW1S$sim_result_summary, "Results/Workplace_PW1S_Demand_Summary.csv")

#run emissions and write to csv
PW1S_output_table <- emissions_fcn(PW1S) 
write_csv(PW1S_output_table$Emissions_Table, "Results/Workplace_PW1S_Output_Summary.csv") #write emissions to csv
write_csv(PW1S_output_table$Emissions, "Results/Workplace_PW1S_Output_All_Hours.csv")




#PW2S = discount + price comm + morning throttling + TOU 2019
PW2S <- simulation(simulations = 1000, sim_seg = "Workplace",
                       sim_month = 7, 
                       sim_year = 2018,
                       sim_new_tou = 2019,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_throttle_amount = -0.5, 
                       sim_throttle_hours = c(7:11),
                       sim_air_pollution_comm = FALSE, #no comm
                       sim_price_comm = TRUE, #yes comm
                       sim_curt_year=2018)

write_csv(PW2S$sim_result_summary, "Results/Workplace_PW2S_Demand_Summary.csv")

#run emissions and write to csv
PW2S_output_table <- emissions_fcn(PW2S) 
write_csv(PW2S_output_table$Emissions_Table, "Results/Workplace_PW2S_Output_Summary.csv") #write emissions to csv
write_csv(PW2S_output_table$Emissions, "Results/Workplace_PW2S_Output_All_Hours.csv")



#PW3S = discount + throttling + all comm
PW3S <- simulation(simulations = 1000, sim_seg = "Workplace",
                       sim_month = 7, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_throttle_amount = -0.5, 
                       sim_throttle_hours = c(7:11),
                       sim_air_pollution_comm = TRUE, #yes comm
                       sim_price_comm = TRUE, #yes comm
                       sim_curt_year=2018) 
write_csv(PW3S$sim_result_summary, "Results/Workplace_PW3S_Demand_Summary.csv")

#run emissions and write to csv
PW3S_output_table <- emissions_fcn(PW3S) 
write_csv(PW3S_output_table$Emissions_Table, "Results/Workplace_PW3S_Output_Summary.csv") #write emissions to csv
write_csv(PW3S_output_table$Emissions, "Results/Workplace_PW3S_Output_All_Hours.csv")




#PW4S = discount + price comm
PW4S <- simulation(simulations = 1000, sim_seg = "Workplace",
                       sim_month = 7, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_throttle_amount = 0, #No throttling 
                       sim_air_pollution_comm = FALSE, 
                       sim_price_comm = TRUE,
                       sim_curt_year=2018) 
#View(PW4S$sim_result_summary)
write_csv(PW4S$sim_result_summary, "Results/Workplace_PW4S_Demand_Summary.csv")

#run emissions and write to csv
PW4S_output_table <- emissions_fcn(PW4S) 
write_csv(PW4S_output_table$Emissions_Table, "Results/Workplace_PW4S_Output_Summary.csv") #write emissions to csv
write_csv(PW4S_output_table$Emissions, "Results/Workplace_PW4S_Output_All_Hours.csv")




#PW5S = discount + throttling + no comm
PW5S <- simulation(simulations = 1000, sim_seg = "Workplace",
                       sim_month = 7, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_throttle_amount = -0.5, 
                       sim_throttle_hours = c(7:11),
                       sim_air_pollution_comm = FALSE, #no comm
                       sim_price_comm = FALSE, # no comm
                       sim_curt_year=2018) 
write_csv(PW5S$sim_result_summary, "Results/Workplace_PW5S_Demand_Summary.csv")

#run emissions and write to csv
PW5S_output_table <- emissions_fcn(PW5S) 
write_csv(PW5S_output_table$Emissions_Table, "Results/Workplace_PW5S_Output_Summary.csv") #write emissions to csv
write_csv(PW5S_output_table$Emissions, "Results/Workplace_PW5S_Output_All_Hours.csv")



#PW6S = discount + throttling + air poll comm
PW6S <- simulation(simulations = 1000, sim_seg = "Workplace",
                       sim_month = 7, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_throttle_amount = -0.5, 
                       sim_throttle_hours = c(7:11),
                       sim_air_pollution_comm = TRUE, #yes comm
                       sim_price_comm = FALSE, 
                       sim_curt_year=2018) 
#View(PW6S$sim_result_summary)
write_csv(PW6S$sim_result_summary, "Results/Workplace_PW6S_Demand_Summary.csv")

PW6S_output_table <- emissions_fcn(PW6S) 
write_csv(PW6S_output_table$Emissions_Table, "Results/Workplace_PW6S_Output_Summary.csv") #write emissions to csv
write_csv(PW6S_output_table$Emissions, "Results/Workplace_PW6S_Output_All_Hours.csv")


```

```{r workplace_graphs, message=FALSE}

#PW1S Graph (discount + price comm + morning throttling)
PW1S_demand_summary <- read_csv("Results/Workplace_PW1S_Demand_Summary.csv") 

graph_tablePW1S <- PW1S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW1S_demand_summary$MT[1])

Demand_GraphPW1S <- ggplot(data = graph_tablePW1S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplaces (PW1S) (discount, price comm, throttling) Hourly Demand Forecast",
  subtitle="Baseline July 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPW1S
ggsave("Results Graphs/Workplace_PW1S_Demand_Summary.pdf", Demand_GraphPW1S, device = "pdf", width = 8, height = 4.5)





#PW2S Graph (discount + price comm + morning throttling + TOU 2019)
PW2S_demand_summary <- read_csv("Results/Workplace_PW2S_Demand_Summary.csv") 

graph_tablePW2S <- PW2S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW1S_demand_summary$MT[1])

Demand_GraphPW2S <- ggplot(data = graph_tablePW2S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplaces (PW2S) (TOU 2019, discount, price comm, throttling) Hourly Demand Forecast",
  subtitle="Baseline July 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPW2S
ggsave("Results Graphs/Workplace_PW2S_Demand_Summary.pdf", Demand_GraphPW2S, device = "pdf", width = 8, height = 4.5)










#PW3S Graph (discount + throttling + all comm)
PW3S_demand_summary <- read_csv("Results/Workplace_PW3S_Demand_Summary.csv") 

graph_tablePW3S <- PW3S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW3S_demand_summary$MT[1])

Demand_GraphPW3S <- ggplot(data = graph_tablePW3S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplaces (PW3S) (discount, all comm, throttling) Hourly Demand Forecast",
  subtitle="Baseline July 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Demand_GraphPW3S
ggsave("Results Graphs/Workplace_PW3S_Demand_Summary.pdf", Demand_GraphPW3S, device = "pdf", width = 8, height = 4.5)





#PW4 Graph (discount + price comm)
PW4S_demand_summary <- read_csv("Results/Workplace_PW4S_Demand_Summary.csv") 

graph_tablePW4S <- PW4S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW3S_demand_summary$MT[1])

Demand_GraphPW4S <- ggplot(data = graph_tablePW4S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplaces (PW4S) (discount, price comm) Hourly Demand Forecast",
  subtitle="Baseline July 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  # geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPW4S
ggsave("Results Graphs/Workplace_PW4S_Demand_Summary.pdf", Demand_GraphPW4S, device = "pdf", width = 8, height = 4.5)


###PW5S = discount + throttling + no comm
PW5S_demand_summary <- read_csv("Results/Workplace_PW5S_Demand_Summary.csv") 

graph_tablePW5S <- PW5S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW3S_demand_summary$MT[1])

Demand_GraphPW5S <- ggplot(data = graph_tablePW5S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplaces (PW5S) (discount, no comm, throttling) Hourly Demand Forecast",
  subtitle="Baseline July 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPW5S
ggsave("Results Graphs/Workplace_PW5S_Demand_Summary.pdf", Demand_GraphPW5S, device = "pdf", width = 8, height = 4.5)


#PW6S = discount + throttling + air poll comm
PW6S_demand_summary <- read_csv("Results/Workplace_PW6S_Demand_Summary.csv") 

graph_tablePW6S <- PW6S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW3S_demand_summary$MT[1])

Demand_GraphPW6S <- ggplot(data = graph_tablePW6S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplaces (PW6S) (discount, air comm, throttling) Hourly Demand Forecast",
  subtitle="Baseline July 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPW6S
ggsave("Results Graphs/Workplace_PW6S_Demand_Summary.pdf", Demand_GraphPW6S, device = "pdf", width = 8, height = 4.5)





```



#DESTINATION CENTERS

```{r destination_center_scenarios, message=FALSE, warning=FALSE}

#PDC1S:  discount -0.05 (default) 12-15+ price comms only + morning throttling
PDC1S <- simulation(simulation = 1000, sim_seg = "Destination Center",sim_throttle_amount = -0.5, sim_month = 7)
#View(PDC1S$sim_result_summary)

write_csv(PDC1S$sim_result_summary, "Results/Destination_Centers_PDC1S_Demand_Summary.csv")

#run emissions and write to csv
PDC1S_output_table <- emissions_fcn(PDC1S) 
#View(PDC1S_output_table$Emissions_Table)
#View(PDC1S_output_table$Emissions)
write_csv(PDC1S_output_table$Emissions_Table, "Results/Destination_Centers_PDC1S_Output_Summary.csv") #write emissions to csv
write_csv(PDC1S_output_table$Emissions, "Results/Destination_Centers_PDC1S_Output_All_Hours.csv")


#PDC2S:  discount -0.05 (default) 12-15+ all comms + morning throttling
PDC2S <- simulation(simulations = 1000, sim_seg = "Destination Center",sim_throttle_amount = -0.5,sim_air_pollution_comm = TRUE, sim_price_comm = TRUE,sim_month = 7)

write_csv(PDC2S$sim_result_summary, "Results/Destination_Centers_PDC2S_Demand_Summary.csv")
#run emissions and write to csv
PDC2S_output_table <- emissions_fcn(PDC2S) 
write_csv(PDC2S_output_table$Emissions_Table, "Results/Destination_Centers_PDC2S_Output_Summary.csv") #write emissions to csv
write_csv(PDC2S_output_table$Emissions, "Results/Destination_Centers_PDC2S_Output_All_Hours.csv")


#PDC3S: discount -0.05 (default) 12-15+ air poll comms + morning throttling
PDC3S <- simulation(simulations = 1000, sim_seg = "Destination Center",sim_throttle_amount = -0.5,sim_air_pollution_comm = TRUE, sim_price_comm = FALSE,sim_month = 7)

write_csv(PDC3S$sim_result_summary, "Results/Destination_Centers_PDC3S_Demand_Summary.csv")
PDC3S_output_table <- emissions_fcn(PDC3S) 
write_csv(PDC3S_output_table$Emissions_Table, "Results/Destination_Centers_PDC3S_Output_Summary.csv") #write emissions to csv
write_csv(PDC3S_output_table$Emissions, "Results/Destination_Centers_PDC3S_Output_All_Hours.csv")


#PDC4S: discount -0.05 (default) 12-15+ no comms + morning throttling
PDC4S <- simulation(simulations = 1000, sim_seg = "Destination Center",sim_throttle_amount =-0.5, sim_month = 7,sim_air_pollution_comm = FALSE,sim_price_comm = FALSE)

write_csv(PDC4S$sim_result_summary, "Results/Destination_Centers_PDC4S_Demand_Summary.csv")
PDC4S_output_table <- emissions_fcn(PDC4S) 
write_csv(PDC4S_output_table$Emissions_Table, "Results/Destination_Centers_PDC4S_Output_Summary.csv") #write emissions to csv
write_csv(PDC4S_output_table$Emissions, "Results/Destination_Centers_PDC4S_Output_All_Hours.csv")


```

```{r destination_center_graphs}
#PDC1S:  discount -0.05 (default) 12-15+ price comms only + morning throttling
PDC1S_demand_summary <- read_csv("Results/Destination_Centers_PDC1S_Demand_Summary.csv") 

graph_tablePDC1S <- PDC1S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphPDC1S <- ggplot(data = graph_tablePDC1S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Centers (PDC1S) (discount, price comms, morning throttling) Hourly Demand Forecast",
  subtitle="Baseline July 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPDC1S
ggsave("Results Graphs/Destination_Centers_PDC1S_Demand_Summary.pdf", Demand_GraphPDC1S, device = "pdf", width = 8, height = 4.5)




#PDC2S:  discount -0.05 (default) 12-15+ all comms + morning throttling
PDC2S_demand_summary <- read_csv("Results/Destination_Centers_PDC2S_Demand_Summary.csv") 

graph_tablePDC2S <- PDC2S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphPDC2S <- ggplot(data = graph_tablePDC2S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Centers (PDC2S) (discount, all comms, morning throttling) Hourly Demand Forecast",
  subtitle="Baseline July 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPDC2S
ggsave("Results Graphs/Destination_Centers_PDC2S_Demand_Summary.pdf", Demand_GraphPDC2S, device = "pdf", width = 8, height = 4.5)




#PDC3S: discount -0.05 (default) 12-15+ air poll comms + morning throttling
PDC3S_demand_summary <- read_csv("Results/Destination_Centers_PDC3S_Demand_Summary.csv") 

graph_tablePDC3S <- PDC3S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphPDC3S <- ggplot(data = graph_tablePDC3S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Centers (PDC3S) (discount, air poll comms, morning throttling) Hourly Demand Forecast",
  subtitle="Baseline July 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPDC3S
ggsave("Results Graphs/Destination_Centers_PDC3S_Demand_Summary.pdf", Demand_GraphPDC3S, device = "pdf", width = 8, height = 4.5)






#PDC4S: discount -0.05 (default) 12-15+ no comms + morning throttling
PDC4S_demand_summary <- read_csv("Results/Destination_Centers_PDC4S_Demand_Summary.csv") 

graph_tablePDC4S <- PDC4S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphPDC4S <- ggplot(data = graph_tablePDC4S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Centers (PDC4S) (discount, no comms, morning throttling) Hourly Demand Forecast",
  subtitle="Baseline July 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPDC1S
ggsave("Results Graphs/Destination_Centers_PDC4S_Demand_Summary.pdf", Demand_GraphPDC4S, device = "pdf", width = 8, height = 4.5)






#PDC2S:  discount -0.05 (default) 12-15+ all comms + morning throttling
write_csv(PDC2S$sim_result_summary, "Results/Destination_Centers_PDC2S_Demand_Summary.csv")
#run emissions and write to csv


#PDC3S: discount -0.05 (default) 12-15+ air poll comms + morning throttling
write_csv(PDC3S$sim_result_summary, "Results/Destination_Centers_PDC3S_Demand_Summary.csv")


#PDC4S: discount -0.05 (default) 12-15+ no comms + morning throttling
write_csv(PDC4S$sim_result_summary, "Results/Destination_Centers_PDC4S_Demand_Summary.csv")

```



#FLEETS

```{r fleet_scenarios, message=FALSE, warning=FALSE}

# PF1: Present, Fleet, 1

PF1 <- simulation(simulations = 1000, 
                       sim_method = mthd,
                       sim_avg_elasticity = avg_elst,
                       sim_seg = "Fleet",
                       sim_month = 11, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_elasticity_schedule = sch, 
                       sim_price_change = 0.10, 
                       sim_intervention_hours = c(17:21),
                       sim_intervention_chargers = int_ch, 
                       sim_int_equals_baseline = int_e_b, 
                       sim_throttle_amount = t_a, 
                       sim_throttle_hours = t_h,
                       sim_air_pollution_comm = a_p_co,
                       sim_price_comm = TRUE)

write_csv(PF1$sim_result_summary, "Results/Fleets_PF1_Demand_Summary.csv")

#run emissions and write to csv
PF1_output_table <- emissions_fcn(PF1) 
write_csv(PF1_output_table$Emissions_Table, "Results/Fleets_PF1_Output_Summary.csv") #write emissions to csv
write_csv(PF1_output_table$Emissions, "Results/Fleets_PF1_Output_All_Hours.csv")




# PF2: Present, Fleet, 2
#  **** Need to add TOU 2019

PF2 <- simulation(simulations = 100, 
                       sim_method = mthd,
                       sim_avg_elasticity = avg_elst,
                       sim_seg = "Fleet",
                       sim_month = 11, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_elasticity_schedule = sch, 
                       sim_price_change = 0.10, 
                       sim_intervention_hours = c(17:21),
                       sim_intervention_chargers = int_ch, 
                       sim_int_equals_baseline = int_e_b, 
                       sim_throttle_amount = t_a, 
                       sim_throttle_hours = t_h,
                       sim_air_pollution_comm = a_p_co,
                       sim_price_comm = TRUE,
                       sim_curt_year=c_yr)
#View(PF2S$sim_result_summary)
#PF2S_output_table <- emissions_fcn(PF2S) 

# PF3S: Present, Fleet, 3, Summer

PF3S <- simulation(simulations = 1000, 
                       sim_method = mthd,
                       sim_avg_elasticity = avg_elst,
                       sim_seg = "Fleet",
                       sim_month = 7, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_elasticity_schedule = sch, 
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_intervention_chargers = int_ch, 
                       sim_int_equals_baseline = int_e_b, 
                       sim_throttle_amount = t_a, 
                       sim_throttle_hours = t_h,
                       sim_air_pollution_comm = a_p_co,
                       sim_price_comm = TRUE,
                       sim_curt_year=c_yr)
write_csv(PF3S$sim_result_summary, "Results/Fleets_PF3S_Demand_Summary.csv")

#run emissions and write to csv
PF3S_output_table <- emissions_fcn(PF3S) 
write_csv(PF3S_output_table$Emissions_Table, "Results/Fleets_PF3S_Output_Summary.csv") #write emissions to csv
write_csv(PF3S_output_table$Emissions, "Results/Fleets_PF3S_Output_All_Hours.csv")




# PF4S: Present, Fleet, 4, Summer

PF4S <- simulation(simulations = 100, 
                       sim_method = mthd,
                       sim_avg_elasticity = avg_elst,
                       sim_seg = "Fleet",
                       sim_month = 7, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_elasticity_schedule = sch, 
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_intervention_chargers = int_ch, 
                       sim_int_equals_baseline = int_e_b, 
                       sim_throttle_amount = -0.5, 

                       sim_throttle_hours = c(6:11, 17:21), # not sure if this should 5:11 or 6:11 and 16:21 or 17:21

                       sim_throttle_hours = c(7:11, 17:21),  ????

                       sim_air_pollution_comm = a_p_co,
                       sim_price_comm = TRUE,
                       sim_curt_year=c_yr)
#View(PF4S$sim_result_summary)
#PF4S_output_table <- emissions_fcn(PF4S) 

# PF5S: Present, Fleet, 5, Summer

PF5S <- simulation(simulations = 100, 
                       sim_method = mthd,
                       sim_avg_elasticity = avg_elst,
                       sim_seg = "Fleet",
                       sim_month = 7, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_elasticity_schedule = sch, 
                       sim_price_change = -0.05, #shoot. how do we run a rebate and a discount?  
                       sim_intervention_hours = c(12:15, 18:21),
                       sim_intervention_chargers = int_ch, 
                       sim_int_equals_baseline = int_e_b, 
                       sim_throttle_amount = t_a, 
                       sim_throttle_hours = t_h,
                       sim_air_pollution_comm = a_p_co,
                       sim_price_comm = TRUE,
                       sim_curt_year=c_yr)
#View(PF5S$sim_result_summary)
#PF5S_output_table <- emissions_fcn(PF5S) 

# FF1: Future, Fleet, 1

FF1 <- simulation(simulations = 1000, 
                       sim_method = mthd,
                       sim_avg_elasticity = avg_elst,
                       sim_seg = "Fleet",
                       sim_month = mth, 
                       sim_year = yr,
                       sim_include_wknds = wknds,
                       sim_charger_power = pwr,
                       sim_elasticity_schedule = sch, 
                       sim_price_change = 0.1,
                       sim_intervention_hours = c(17:21),
                       sim_intervention_chargers = 4378,
                       sim_int_equals_baseline = FALSE, 
                       sim_throttle_amount = t_a, 
                       sim_throttle_hours = t_h,
                       sim_air_pollution_comm = a_p_co,
                       sim_price_comm = TRUE,
                       sim_curt_year=c_yr)

write_csv(FF1$sim_result_summary, "Results/Fleets_FF1_Demand_Summary.csv")

#run emissions and write to csv
FF1_output_table <- emissions_fcn(FF1, emissions_year = 2030) 
write_csv(FF1_output_table$Emissions_Table, "Results/Fleets_FF1_Output_Summary.csv") #write emissions to csv
write_csv(FF1_output_table$Emissions, "Results/Fleets_FF1_Output_All_Hours.csv")


```


```{r fleet_graphs}

# PF1: Present, Fleet, 1 (rebate, price comm, 83 chargers)
PF1_demand_summary <- read_csv("Results/Fleets_PF1_Demand_Summary.csv") 

graph_tablePF1 <- PF1_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW1S_demand_summary$MT[1])

Demand_GraphPF1 <- ggplot(data = graph_tablePF1, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Fleets (PF1) (rebate, price comm) Hourly Demand Forecast",
  subtitle="Baseline November 2018 (83 Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
 # geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPF1
ggsave("Results Graphs/Fleets_PF1_Demand_Summary.pdf", Demand_GraphPF1, device = "pdf", width = 8, height = 4.5)



# PF3S: Present, Fleet, 3(discount, price comm)
PF3S_demand_summary <- read_csv("Results/Fleets_PF3S_Demand_Summary.csv") 

graph_tablePF3S <- PF3S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW1S_demand_summary$MT[1])

Demand_GraphPF3S <- ggplot(data = graph_tablePF3S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Fleets (PF3) (discount, price comm) Hourly Demand Forecast",
  subtitle="Baseline July 2018 (83 Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
 # geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPF3S
ggsave("Results Graphs/Fleets_PF3S_Demand_Summary.pdf", Demand_GraphPF3S, device = "pdf", width = 8, height = 4.5)


# FF1: Future, 2019 tou, rebate, price comm
FF1_demand_summary <- read_csv("Results/Fleets_FF1_Demand_Summary.csv") 

graph_tableFF1 <- FF1_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW1S_demand_summary$MT[1])

Demand_GraphFF1 <- ggplot(data = graph_tableFF1, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Fleets (FF1) (2019 tou, price comm, 2030 chargers) Hourly Demand Forecast",
  subtitle="Baseline Nov 2018 (83 Chargers) \n Model Simulation (2030 scenario)",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
 # geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Demand_GraphFF1
ggsave("Results Graphs/Fleets_FF1_Demand_Summary.pdf", Demand_GraphFF1, device = "pdf", width = 8, height = 4.5)


```



#MUDS

```{r MUDs_scenarios, message=FALSE, warning=FALSE}

#PM1 = rebate + price communication
PM1 <- simulation(simulation = 1000, sim_seg = "Multi Unit Dwelling",
                       sim_month = 11,
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_price_change = 0.1, 
                       sim_intervention_hours = c(17:21),
                       sim_air_pollution_comm = FALSE,
                       sim_price_comm = TRUE,
                       sim_curt_year=2018) 
#View(PM1$sim_result_summary)

#CSV + OUTPUTS
#write simulation summary results to csv to use for graph!
write_csv(PM1$sim_result_summary, "Results/MUDs_PM1_Demand_Summary.csv")

#run emissions and write to csv
PM1_output_table <- emissions_fcn(PM1) 
#View(PM1_output_table$Emissions_Table)
#View(PM1_output_table$Emissions)
write_csv(PM1_output_table$Emissions_Table, "Results/MUDs_PM1_Output_Summary.csv") #write emissions to csv
write_csv(PM1_output_table$Emissions, "Results/MUDs_PM1_Output_All_Hours.csv")

#to run defaults
#PM1_output_table <- emissions_fcn(EVDemand = PM1, peak_hours = c(17:21), emissions_year = 2019)
#things to CSV: summary table from montecarlo (for graphing); sim_result_summary$summary; PM1_output_table (emissions$Emissions_Table); PM1_output_emissions_all (Emissions$Emissions); 



#PM2 = throttling + price comms (can't run throttling with no comms b/c comms is contingent on a price change). so this is a little weird. 
PM2 <- simulation(simulation =1000, sim_seg = "Multi Unit Dwelling",
                       sim_month = 11,
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_price_change = 0,
                       sim_intervention_hours = c(17:21), #set so calculates values based on that period
                       sim_throttle_amount = -0.5, 
                       sim_throttle_hours = c(17:21),
                       sim_air_pollution_comm = FALSE,
                       sim_price_comm = TRUE,
                       sim_curt_year=2018)
#View(PM2$sim_result_summary)

#write simulation summary results to csv to use for graph!
write_csv(PM2$sim_result_summary, "Results/MUDs_PM2_Demand_Summary.csv")

#run emissions and write to csv
PM2_output_table <- emissions_fcn(PM2) 
#View(PM2_output_table$Emissions_Table)
#View(PM2_output_table$Emissions)
write_csv(PM2_output_table$Emissions_Table, "Results/MUDs_PM2_Output_Summary.csv") #write emissions to csv
write_csv(PM2_output_table$Emissions, "Results/MUDs_PM2_Output_All_Hours.csv")


#PM3 = new tou + rebate + price communication
PM3 <- simulation (simulation = 1000, sim_seg = "Multi Unit Dwelling",
                       sim_month = 11,
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_price_change = 0.1, 
                       sim_intervention_hours = c(17:21),
                       sim_air_pollution_comm = FALSE,
                       sim_price_comm = TRUE,
                       sim_curt_year=2018,
                       sim_new_tou = 2019)

#View(PM3$sim_result_summary)
#write simulation summary results to csv to use for graph!
write_csv(PM3$sim_result_summary, "Results/MUDs_PM3_Demand_Summary.csv")
PM3_demand_summary <- read_csv("Results/MUDs_PM3_Demand_Summary.csv") #read it back in for the graph

#run emissions and write to csv
PM3_output_table <- emissions_fcn(PM3) 
#View(PM3_output_table$Emissions_Table)
#View(PM3_output_table$Emissions)
write_csv(PM3_output_table$Emissions_Table, "Results/MUDs_PM3_Output_Summary.csv") #write emissions to csv
write_csv(PM3_output_table$Emissions, "Results/MUDs_PM3_Output_All_Hours.csv")

#PM4 = new tou + all communication
PM4 <- simulation (simulation = 1000, sim_seg = "Multi Unit Dwelling",
                       sim_month = 11,
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_price_change = 0,
                       sim_intervention_hours = c(1:24),
                       sim_air_pollution_comm = TRUE,
                       sim_price_comm = TRUE,
                       sim_curt_year=2018,
                       sim_new_tou = 2019)
#View(PM4$sim_result_summary)
#write simulation summary results to csv to use for graph!
write_csv(PM4$sim_result_summary, "Results/MUDs_PM4_Demand_Summary.csv")
PM4_demand_summary <- read_csv("Results/MUDs_PM2_Demand_Summary.csv") #read it back in for the graph

#run emissions and write to csv
PM4_output_table <- emissions_fcn(PM4) 
#View(PM4_output_table$Emissions_Table)
#View(PM4_output_table$Emissions)
write_csv(PM4_output_table$Emissions_Table, "Results/MUDs_PM4_Output_Summary.csv") #write emissions to csv
write_csv(PM4_output_table$Emissions, "Results/MUDs_PM4_Output_All_Hours.csv")



#PM 5 = new tou + air pollution communication
PM5 <- simulation (simulation = 1000, sim_seg = "Multi Unit Dwelling",
                       sim_month = 11,
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_price_change = 0,
                       sim_intervention_hours = c(1:24),
                       sim_air_pollution_comm = TRUE,
                       sim_price_comm = FALSE,
                       sim_curt_year=2018,
                       sim_new_tou = 2019)
#View(PM5$sim_result_summary)
#write simulation summary results to csv to use for graph!
write_csv(PM5$sim_result_summary, "Results/MUDs_PM5_Demand_Summary.csv")

#run emissions and write to csv
PM5_output_table <- emissions_fcn(PM5) 
#View(PM5_output_table$Emissions_Table)
#View(PM5_output_table$Emissions)
write_csv(PM5_output_table$Emissions_Table, "Results/MUDs_PM5_Output_Summary.csv") #write emissions to csv
write_csv(PM5_output_table$Emissions, "Results/MUDs_PM5_Output_All_Hours.csv")

#add scenario for air pollution + discount? 

#FM1 = 2030 + 2019 tou + rebate
FM1 <- simulation (simulation = 1000, sim_seg = "Multi Unit Dwelling",
                       sim_month = 11,
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_price_change = 0.1, 
                       sim_intervention_hours = c(17:21),
                       sim_intervention_chargers = 1846, 
                       sim_int_equals_baseline = FALSE, 
                       sim_air_pollution_comm = TRUE,
                       sim_price_comm = TRUE,
                       sim_curt_year=2030,
                       sim_new_tou = 2019)
#View(FM1$sim_result_summary)

#write simulation summary results to csv to use for graph!
write_csv(FM1$sim_result_summary, "Results/MUDs_FM1_Demand_Summary.csv")

#run emissions and write to csv
FM1_output_table <- emissions_fcn(EVDemand=FM1, emissions_year = 2030) 
#View(FM1_output_table$Emissions_Table)
#View(FM1_output_table$Emissions)
write_csv(FM1_output_table$Emissions_Table, "Results/MUDs_FM1_Output_Summary.csv") #write emissions to csv
write_csv(FM1_output_table$Emissions, "Results/MUDs_FM1_Output_All_Hours.csv")

```

```{r MUDs_graphs}

#PM1 = rebate + price communication + no throttling
PM1_demand_summary <- read_csv("Results/MUDs_PM1_Demand_Summary.csv") 

graph_tablePM1 <- PM1_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphPM1 <- ggplot(data = graph_tablePM1, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="MUDs (PM1) (rebate, price comm) Hourly Demand Forecast",
  subtitle="Baseline November 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  # geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPM1
ggsave("Results Graphs/MUDs_PM1_Demand_Summary.pdf", Demand_GraphPM1, device = "pdf", width = 8, height = 4.5)




#PM2 = throttling + price comms (can't run throttling with no comms b/c comms is contingent on a price change). so this is a little weird
PM2_demand_summary <- read_csv("Results/MUDs_PM2_Demand_Summary.csv")

graph_tablePM2 <- PM2_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphPM2 <- ggplot(data = graph_tablePM2, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="MUDs (PM2) (throttling, price comm) Hourly Demand Forecast",
  subtitle="Baseline November 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  #geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

#Demand_GraphPM2
ggsave("Results Graphs/MUDs_PM2_Demand_Summary.pdf", Demand_GraphPM2, device = "pdf", width = 8, height = 4.5)



#PM3 = new tou + rebate + price communication
PM3_demand_summary <- read_csv("Results/MUDs_PM3_Demand_Summary.csv") 

graph_tablePM3 <- PM3_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphPM3 <- ggplot(data = graph_tablePM3, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="MUDs (PM3) (new tou, rebate, price comm) Hourly Demand Forecast",
  subtitle="Baseline November 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  #geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

#Demand_GraphPM3
ggsave("Results Graphs/MUDs_PM3_Demand_Summary.pdf", Demand_GraphPM3, device = "pdf", width = 8, height = 4.5)




#PM4 = new tou + all communication
PM4_demand_summary <- read_csv("Results/MUDs_PM4_Demand_Summary.csv") 

graph_tablePM4 <- PM4_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphPM4 <- ggplot(data = graph_tablePM4, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="MUDs (PM4) (new tou, all comms) Hourly Demand Forecast",
  subtitle="Baseline November 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  #geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  #geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") # +
  #scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

#Demand_GraphPM4
ggsave("Results Graphs/MUDs_PM4_Demand_Summary.pdf", Demand_GraphPM4, device = "pdf", width = 8, height = 4.5)




#PM 5 = new tou + air pollution communication
PM5_demand_summary <- read_csv("Results/MUDs_PM5_Demand_Summary.csv") 

graph_tablePM5 <- PM5_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphPM5 <- ggplot(data = graph_tablePM5, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="MUDs (PM5) (new tou, air poll comms) Hourly Demand Forecast",
  subtitle="Baseline November 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  #geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  #geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") # +
  #scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

#Demand_GraphPM5
ggsave("Results Graphs/MUDs_PM5_Demand_Summary.pdf", Demand_GraphPM5, device = "pdf", width = 8, height = 4.5)



#FM1 = 2030 + 2019 tou + rebate
FM1_demand_summary <- read_csv("Results/MUDs_FM1_Demand_Summary.csv") 

graph_tableFM1 <- FM1_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphFM1 <- ggplot(data = graph_tableFM1, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="MUDs (FM1) (2030 scaled, 2019 tou, rebate) Hourly Demand Forecast",
  subtitle="Baseline November 2018 (X Chargers) \n Model Simulation Scaled 2030",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  #geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") # +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

#Demand_GraphFM1
ggsave("Results Graphs/MUDs_FM1_Demand_Summary.pdf", Demand_GraphFM1, device = "pdf", width = 8, height = 4.5)


```




## Report Elasticity + Methods Graphs (for examples)
```{r example_graphs, message=FALSE, warning=FALSE}

#one fully splined elasticity -- want this as a line graph
Method1_test <- hourly_demand(method = 1, include_wknds = FALSE, price_comm = FALSE, elasticity_schedule = 7) #selecting winter weekday ev medium as example elasticity set

spline_example <- Method1_test$matrix[12] #turn this into a line graph. 



#one 24 x 24 hour matrix from one set of SDGE elasticities with cross (I need to know which set) -- want this heat mapped
heat_map_matrix<-Method1_test$matrix #turn this into a heat map



#One run of each method for the same scenario (Default for all: Workplace, November, 2018, no weekends, 5 cent discount 12:15, baseline # chargers, no throttling, no air pollution communication, no price communication, 2018 tou) -- want a graphed output of baseline versus intervention for each 
#Method1 -- run above
Method1_test_for_graph <- Method1_test$EV_Demand

#Method 2
Method2_test <- hourly_demand(method = 2, include_wknds = FALSE, price_comm = FALSE, elasticity_schedule = 7)
Method2_test_for_graph <- Method2_test$EV_Demand

#Method 3
Method3_test <- hourly_demand(method = 3, include_wknds = FALSE, price_comm = FALSE, elasticity_schedule = 7)
Method3_test_for_graph <- Method3_test$EV_Demand

#Method 4 (default run - average elasticity = -0.4)
Method4_test <- hourly_demand(method = 4, include_wknds = FALSE, price_comm = FALSE, elasticity_schedule = 7)
Method4_test_for_graph <- Method4_test$EV_Demand


#One run of the simulation for the same scenario above -- want a graphed output (same as what the result simulation graph looks like for all of them)
Sim_test_report <- simulation(simulations = 1000, sim_include_wknds = FALSE, sim_price_comm = FALSE)

```



##Scenario 1
Workplace (November 2018), TOU EV4, $0.05 Discount (11AM-3PM), 50% THrottle, 80% reduction in comm
```{r Scenario 1}

#MODEL RUN
WP_C_D_T_TOU_SUmmer_4 <- hourly_demand(segment = "Workplace", 
                                       month = "Nov_18",
                                       price_change = -0.05,
                                       intervention_hours = c(12:15),
                                       throttle_amount = -0.5, 
                                       throttle_hours = c(7:11),
                                       intervention_comm_effect = 0.2)


#GRAPH

graph_table1 <- WP_C_D_T_TOU_SUmmer_4$EV_Demand[c("Hr","X0","Xf")] %>% 
  gather(condition,value,X0:Xf) %>% 
  mutate(Theoretical_Max=WP_C_D_T_TOU_SUmmer_4$EV_Demand$MT[1])


Demand_Graph1 <- ggplot(data = graph_table1, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title=" Workplace Hourly Demand Forecast", 
       subtitle="$0.05 Discount 11 AM - 3 PM \n 50% Throttling 6 AM - 11 AM \n 80% Reduced Communication Effect",
       y="EV Charging Demand (kW)",
       x="Hour",
       color=NULL) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Demand with Intervention"), values = c("blue", "red")) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme(plot.subtitle = element_text(hjust = 0.5))+
 theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

Potential_Graph1 <- Demand_Graph1 +
  geom_line(aes(y=Theoretical_Max))

Demand_Graph1

ggsave("Workplace_2018_Nov_DThC.pdf", Demand_Graph1, device = "pdf", width = 8, height = 4.5)

#Potential_Graph1

```

##Scenario 3
MUD (June 2018), TOU EV-4, $0.10 rebate (4-9PM) 

```{r Scenario 3}

##MODEL RUN
MUD_R_C <- hourly_demand(segment = "Multi Unit Dwelling", 
                         month = "June_18", 
                         price_change = 0.1 , 
                         intervention_hours = c(17:21))


##GRAPH

graph_table3 <- MUD_R_C$EV_Demand[c("Hr","X0","Xf")] %>% 
  gather(condition,value,X0:Xf) %>% 
  mutate(Theoretical_Max=MUD_R_C$EV_Demand$MT[1])


Demand_Graph3 <- ggplot(data = graph_table3, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title=" Multi-Unit Dwelling Hourly Demand Forecast", 
       subtitle="$0.10 Rebate 4 PM - 9 PM",
       y="EV Charging Demand (kW)",
       x="Hour",
       color=NULL) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Demand with Intervention"), values = c("blue", "red")) +
  geom_rect(aes(xmin=17,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme(plot.subtitle = element_text(hjust = 0.5))+
 theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('blue'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

Potential_Graph3 <- Demand_Graph3 +
  geom_line(aes(y=Theoretical_Max))

Demand_Graph3
#Potential_Graph3

ggsave("MUD_2018_Jun_R.pdf", Demand_Graph1, device = "pdf", width = 8, height = 4.5)


```


#Scenario 4
Destination Center (June 2018), TOU EV-4, $0.05 discount (11AM-3PM), 50% throttle
```{r Scenario 4}


#MODEL RUN
DC_D_T_NC <- hourly_demand(segment = "Destination Center", 
                           month = "June_18", 
                           intervention_hours = c(12:15),
                           price_change = -0.05, 
                           throttle_amount = -0.5, throttle_hours = c(7:11))


#GRAPH
graph_table4 <- DC_D_T_NC$EV_Demand[c("Hr","X0","Xf")] %>% 
  gather(condition,value,X0:Xf) %>% 
  mutate(Theoretical_Max=DC_D_T_NC$EV_Demand$MT[1])


Demand_Graph4 <- ggplot(data = graph_table4, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Center Hourly Demand Forecast", 
       subtitle="$0.05 Discount 11 AM - 3 PM \n 50% Throttling 6 AM - 11 AM \n",
       y="EV Charging Demand (kW)",
       x="Hour",
       color=NULL) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Demand with Intervention"), values = c("blue", "red")) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf, fill = "Throttle"),alpha=0.0075) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

Potential_Graph4 <- Demand_Graph4 +
  geom_line(aes(y=Theoretical_Max))

Demand_Graph4
#Potential_Graph4

ggsave("DC_2018_June_DTh.pdf", Demand_Graph4, device = "pdf", width = 8, height = 4.5)

```


#Scenario 5
Fleet (August 2018), TOU EV-4, $0.10 rebate (4-9PM) 

```{r}


#MODEL RUN
Fleet_R <-  hourly_demand(segment = "Fleet", 
                        month = "Aug_18", 
                        intervention_hours = c(17:21), 
                        price_change = 0.1)

#GRAPH
graph_table5 <- Fleet_R$EV_Demand[c("Hr","X0","Xf")] %>% 
  gather(condition,value,X0:Xf) %>% 
  mutate(Theoretical_Max=Fleet_R$EV_Demand$MT[1])


Demand_Graph5 <- ggplot(data = graph_table5, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Fleet Hourly Demand Forecast", 
       subtitle="$0.10 Rebate 4 PM - 9 PM",
       y="EV Charging Demand (kW)",
       x="Hour",
       color=NULL) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Demand with Intervention"), values = c("blue", "red")) +
  geom_rect(aes(xmin=17,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme(plot.subtitle = element_text(hjust = 0.5))+
 theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('blue'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

Potential_Graph5 <- Demand_Graph5 +
  geom_line(aes(y=Theoretical_Max))

Demand_Graph5
#Potential_Graph5

ggsave("Fleet_2018_Aug_R.pdf", Demand_Graph5, device = "pdf", width = 8, height = 4.5)
```

#Scenario 6
Workplace (November 2018), TOU EV-4, $0.05 Discount (11AM-3PM), 50% throttle
```{r Scenario 6}


#MODEL RUN
WP_D_T <- hourly_demand(segment = "Workplace", 
                        month = "Nov_18", 
                        intervention_hours = c(12:15),
                        price_change = -0.05,
                        throttle_amount = -0.5,
                        throttle_hours = c(7:11))


#GRAPH
graph_table6 <-WP_D_T$EV_Demand[c("Hr","X0","Xf")] %>% 
  gather(condition,value,X0:Xf) %>% 
  mutate(Theoretical_Max=WP_D_T$EV_Demand$MT[1])


Demand_Graph6 <- ggplot(data = graph_table6, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title=" Workplace Hourly Demand Forecast", 
       subtitle="$0.05 Discount 11 AM - 3 PM \n 50% Throttling 6 AM - 11 AM",
       y="EV Charging Demand (kW)",
       x="Hour",
       color=NULL) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Demand with Intervention"), values = c("blue", "red")) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme(plot.subtitle = element_text(hjust = 0.5))+
 theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

Potential_Graph6 <- Demand_Graph6 +
  geom_line(aes(y=Theoretical_Max))

Demand_Graph6
#Potential_Graph6

ggsave("Workplace_2018_Nov_DTh.pdf", device = "pdf", width = 8, height = 4.5)

```

#Scenario 7
Workplace November 2018
Baseline + Event (Nov 14, 2018) + Model Run(DThC)
```{r}
#Scenario 7
#Scale baseline to Nov 14,2018 event 
nov_14_18_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Nov_14_18_LS) %>%
unlist()


Nov_14_18_scaled_model_run <- hourly_demand(price_change = -0.05,
throttle_amount = -0.5,
month = 11,
year = 2018,
seg =  "Workplace",
intervention_chargers =
nov_14_18_event,
int_equals_baseline = FALSE)


nov_14_18_Event_Usage <- Workplace_Event_Total_Usage$Nov_14_18_LS
Nov_14_18_scaled_model_run$EV_Demand <- Nov_14_18_scaled_model_run$EV_Demand %>% 
  mutate(Event_Usage = nov_14_18_Event_Usage)

graph_table7 <- Nov_14_18_scaled_model_run$EV_Demand[c("Hr","X0","Xf","Event_Usage")] %>% 
  gather(condition,value,c("X0","Xf","Event_Usage")) %>% 
  mutate(Theoretical_Max=Nov_14_18_scaled_model_run$EV_Demand$MT[1])


Demand_Graph7 <- ggplot(data = graph_table7, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplace Hourly Demand Forecast", 
       subtitle="Baseline November 2018 Scaled for November 14th, 2018 Event Number of Chargers \n Modeled $0.05 Discount 11 AM - 3 PM \n Modeled 50% Throttling 6 AM - 11 AM \n Modeled 50% Lesser Communication Effect",
       y="EV Charging Demand (kW)",
       x="Hour",
       color=NULL) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand", "Modeled Demand"), values = c("purple", "blue", "red")) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

Potential_Graph7 <- Demand_Graph7 +
  geom_line(aes(y=Theoretical_Max))

Demand_Graph7
```



#Scenario 8
Workplace (November 2018), $0.05 Discount, SELF ONLY

```{r}
###Workplace discount only self (Hour 12)

#No Cross Elasticities
#needs to use No_Cross_Matrix for this to run correctly
no_cross_discount <- hourly_demand(seg = "Workplace", 
                                       month = 11,
                                        year = 2018,
                                       price_change = -0.05,
                                       intervention_hours = c(12:15),
                                       throttle_amount = 0, 
                                       throttle_hours = c(7:11))
write_csv(no_cross_discount$EV_Demand, "WP_Discount_No_Cross_Nov_18.csv")

graph_table8 <- no_cross_results[c("Hr","X0","Xf")] %>% 
  gather(condition,value,X0:Xf) %>% 
  mutate(Theoretical_Max=no_cross_results$MT[1])


Demand_Graph8 <- ggplot(data = graph_table8, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition, linetype = condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title=" Workplace Hourly Demand Forecast", 
       subtitle="$0.05 Discount 11 AM - 3 PM \n No Cross Elasticity",
       y="EV Charging Demand (kW)",
       x="Hour",
       color=NULL) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(name = " ",labels=c("Baseline Demand","Demand with Intervention"), values = c("blue","red")) +
  scale_linetype_manual(name = " ",labels=c("Baseline Demand","Demand with Intervention"), values = c("solid","dashed")) +
  #scale_size_manual(labels=c("Baseline Demand","Demand with Intervention"), values = c(0.75,0.5)) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_fill_manual('Interventions',values = c('green'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

Potential_Graph8 <- Demand_Graph8 +
  geom_line(aes(y=Theoretical_Max))

Demand_Graph8
ggsave("Self_Only.pdf", device = "pdf", width = 8, height = 4.5)
```

#Scenario 9
Workplace (November 2018), $0.05 Discount, SELF & CROSS

```{r}
#Scenario 9
###Workplace discount only self and cross (Hour 12)

WP_Cross_D <- hourly_demand(seg = "Workplace", 
                                       month = 11,
                                      year = 2018,
                                       price_change = -0.05,
                                       intervention_hours = c(12:15),
                                       throttle_amount = 0)




graph_table9 <- WP_Cross_D$EV_Demand[c("Hr","X0","Xf")] %>% 
  gather(condition,value,X0:Xf) %>% 
  mutate(Theoretical_Max=WP_Cross_D$EV_Demand$MT[1])


Demand_Graph9 <- ggplot(data = graph_table9, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition, linetype = condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title=" Workplace Hourly Demand Forecast", 
       subtitle="$0.05 Discount 11 AM - 3 PM \n Self and Cross Elasticity",
       y="EV Charging Demand (kW)",
       x="Hour",
       color=NULL) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(name = " ",labels=c("Baseline Demand","Demand with Intervention"), values = c("blue","red")) +
  scale_linetype_manual(name = " ",labels=c("Baseline Demand","Demand with Intervention"), values = c("solid","dashed")) +
  #scale_size_manual(labels=c("Baseline Demand","Demand with Intervention"), values = c(0.75,0.5)) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_fill_manual('Interventions',values = c('green'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

Potential_Graph9 <- Demand_Graph9 +
  geom_line(aes(y=Theoretical_Max))

Demand_Graph9

ggsave("Self_and_Cross.pdf", device = "pdf", width = 8, height = 4.5)
#Potential_Graph1
```



#Scenario 10 - Nov 14, 2018 Event + Baseline (scaled) + Intervention

Model: Workplace (scaled for November 14, 2018: 546 chargers), TOU EV-4, $0.05 Discount (11AM-3PM), 50% Comm reduction

Event: Workplace, November 14, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)


```{r Scenario 10}

#CHARGERS
nov_14_18_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Nov_14_18_LS) %>%
unlist()




#MODEL RUN
Nov_14_18_scaled_model_run_no_throttle <- hourly_demand(price_change = -0.05,
      throttle_amount = 0,
      month = "Nov_18",
      segment =  "Workplace",
      intervention_chargers = nov_14_18_event,
      int_equals_baseline = FALSE,
      intervention_comm_effect = 0.5)

nov_14_18_Event_Usage <- Workplace_Event_Total_Usage$Nov_14_18_LS

Nov_14_18_scaled_model_run_no_throttle$EV_Demand <- Nov_14_18_scaled_model_run_no_throttle$EV_Demand %>% 
  mutate(Event_Usage = nov_14_18_Event_Usage)



#GRAPH

graph_table10 <- Nov_14_18_scaled_model_run_no_throttle$EV_Demand[c("Hr","X0","Xf","Event_Usage")] %>% 
  gather(condition,value,c("X0","Xf","Event_Usage")) %>% 
  mutate(Theoretical_Max=Nov_14_18_scaled_model_run_no_throttle$EV_Demand$MT[1])


Demand_Graph10 <- ggplot(data = graph_table10, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplace Hourly Demand Forecast", 
       subtitle="Baseline November 2018 Scaled for November 14th, 2018 Event Number of Chargers \n Modeled $0.05 Discount 11 AM - 3 PM \n Modeled 50% Throttling 6 AM - 11 AM \n Modeled 50% Lesser Communication Effect",
       y="EV Charging Demand (kW)",
       x="Hour",
       color=NULL) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand", "Modeled Demand"), values = c("purple", "blue", "red")) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

Potential_Graph10 <- Demand_Graph10 +
  geom_line(aes(y=Theoretical_Max))

Demand_Graph10

ggsave("Workplace_2018_Nov_14_LSEvent.pdf", device = "pdf", width = 8, height = 4.5)

```

#Scenario 11
Workplace (November 2018), $0.05 Discount

```{r}
#Scenario 11
#Just Price Change
#-Workplaces: Communication + Discount on current TOU rate

WP_C_D <- hourly_demand(seg = "Workplace", 
                                       month = 11,
                                      year = 2018,
                                       price_change = -0.05,
                                       intervention_hours = c(12:15),
                                       throttle_amount = 0)

graph_table11 <- WP_C_D$EV_Demand[c("Hr","X0","Xf")] %>%
  gather(condition,value,X0:Xf) %>%
  mutate(Theoretical_Max=WP_C_D$EV_Demand$MT[1])


Demand_Graph11 <- ggplot(data = graph_table11, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title=" Workplace Hourly Demand Forecast",
  subtitle="$0.05 Discount 11 AM - 3 PM",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Demand with Intervention"), values = c("blue", "red")) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green'),  guide = guide_legend(override.aes = list(alpha = 0.15)))


Potential_Graph11 <- Demand_Graph11 +
geom_line(aes(y=Theoretical_Max))


Demand_Graph11
ggsave("Workplace_Result_Just_Price.pdf", Demand_Graph11, device = "pdf", width = 8, height = 4.5)
```


#Scenario 12
Workplace (November 2018), $0.05 Discount (11AM-3Pm), 80% reduction in comm

```{r Scenario 12}
#does not have comm!! need to adjust wih new variables


WP_C_D_comm <- hourly_demand(seg = "Workplace", 
                                       month = 11,
                                        year = 2018,
                                       price_change = -0.05,
                                       intervention_hours = c(12:15),
                                       throttle_amount = 0)

graph_table12 <- WP_C_D_comm$EV_Demand[c("Hr","X0","Xf")] %>%
  gather(condition,value,X0:Xf) %>%
  mutate(Theoretical_Max=WP_C_D_comm$EV_Demand$MT[1])

Demand_Graph12 <- ggplot(data = graph_table12, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title=" Workplace Hourly Demand Forecast",
  subtitle="$0.05 Discount 11 AM - 3 PM \n 80% Reduced Communication Effect",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Demand with Intervention"), values = c("blue", "red")) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green'),  guide = guide_legend(override.aes = list(alpha = 0.15)))


Potential_Graph12 <- Demand_Graph12 +
geom_line(aes(y=Theoretical_Max))


Demand_Graph12

ggsave("Workplace_Result_with_comm.pdf", Demand_Graph12, device = "pdf", width = 8, height = 4.5)
```


~~~~~~~PILOT EVENTS~~~~~~~~~~~

#Scenario 13- Nov 14, 2018 EVENT + Baseline (scaled for 546 chargers) 

Event: Workplace, November 14, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 13}

#Scaled Baseline and Nov 14 event usage

#CHARGERS
nov_14_18_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Nov_14_18_LS) %>%
unlist()


Nov_14_18_scaled_baseline <- hourly_demand(
                    month = 11,
                    year= 2018,
                    seg =  "Workplace",
                    intervention_chargers =
                    nov_14_18_event,
                    int_equals_baseline = FALSE)



nov_14_18_Event_Usage <- filter(event_data, Date == "2018-11-14" & segment == "Workplace") %>%
select(Demand) %>%
unlist() 

Nov_14_18_scaled_baseline$EV_Demand <- Nov_14_18_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = nov_14_18_Event_Usage)


graph_table13 <- Nov_14_18_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Nov_14_18_scaled_baseline$EV_Demand$MT[1])


Demand_Graph13 <- ggplot(data = graph_table13, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplace Hourly Demand Forecast",
  subtitle="Baseline November 2018 Scaled for November 14th, 2018 Event (546 Chargers) \n Event Usage November 14th, 2018 Event",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph13 <- Demand_Graph13 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph13

ggsave("Nov_14_Event_Usage.pdf", Demand_Graph13, device = "pdf", width = 8, height = 4.5)

#COST
Cost_Table13 <- Nov_14_18_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table13)


```


#Scenario 14- Nov 28, 2018 Event + Baseline (scaled for 434 chargers) 

Event: Workplace, November 28, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 14}

#CHARGERS
nov_28_18_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Nov_28_18_LS) %>%
unlist()

Nov_28_18_scaled_baseline <- hourly_demand(
                    month = 11,
                    year=2018,
                    seg = "Workplace",
                    intervention_chargers =
                    nov_28_18_event,
                    int_equals_baseline = FALSE)



nov_28_18_Event_Usage <- filter(event_data, Date == "2018-11-28" & segment == "Workplace") %>%
select(Demand) %>%
unlist() 


Nov_28_18_scaled_baseline$EV_Demand <- Nov_28_18_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = nov_28_18_Event_Usage) 


graph_table14 <- Nov_28_18_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Nov_28_18_scaled_baseline$EV_Demand$MT[1])


Demand_Graph14 <- ggplot(data = graph_table14, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplace Hourly Demand Forecast",
  subtitle="Baseline November 2018 Scaled for November 28th, 2018 Event (434 Chargers) \n Event Usage November 28th, 2018 Event",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph14 <- Demand_Graph14 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph14

ggsave("Nov_28_Event_Usage.pdf", Demand_Graph14, device = "pdf", width = 8, height = 4.5)

#COST
Cost_Table14 <- Nov_28_18_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0) 
#View(Cost_Table14)


```


#Scenario 15- October 30, 2018 Event + Baseline (scaled for 377 chargers) 

Event: Workplace, October 30, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 15}

#Scaled Baseline and Nov 14 event usage

#CHARGERS
Oct_30_18_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Oct_30_18_LS) %>%
unlist()

Oct_30_18_scaled_model_run <- hourly_demand(
                    month = 10,
                    year = 2018,
                    seg =  "Workplace",
                    intervention_chargers =
                    Oct_30_18_event,
                    int_equals_baseline = FALSE
                    )

Oct_30_18_Event_Usage <- filter(event_data, Date == "2018-10-30" & segment == "Workplace") %>%
select(Demand) %>%
unlist()


Oct_30_18_scaled_model_run$EV_Demand <- Oct_30_18_scaled_model_run$EV_Demand %>%
  mutate(Event_Usage = Oct_30_18_Event_Usage) 



graph_table15 <- Oct_30_18_scaled_model_run$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Oct_30_18_scaled_model_run$EV_Demand$MT[1])


Demand_Graph15 <- ggplot(data = graph_table15, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplace Hourly Demand Forecast",
  subtitle="Baseline October 2018 Scaled for October 30th, 2018 Event (377 Chargers) \n Event Usage October 30th, 2018 Event",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph15 <- Demand_Graph15 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph15

ggsave("Oct_30_Event_Usage.pdf", Demand_Graph15, device = "pdf", width = 8, height = 4.5)

#COST
Cost_Table15 <- Oct_30_18_scaled_model_run$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table15)
```


#Scenario 16: October 16, 2018 Event + Baseline (scaled for 494 chargers) 

Event: Workplace, October 16, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 16}

#Scaled Baseline and Oct 16 event usage

#CHARGERS
Oct_16_18_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Oct_16_18_LS) %>%
unlist()

Oct_16_18_scaled_model_run <- hourly_demand(
                    month = 10,
                    year = 2018,
                    seg =  "Workplace",
                    intervention_chargers =
                    Oct_16_18_event,
                    int_equals_baseline = FALSE)


Oct_16_18_Event_Usage <- filter(event_data, Date == "2018-10-16" & segment == "Workplace") %>%
select(Demand) %>%
unlist()

Oct_16_18_scaled_model_run$EV_Demand <- Oct_16_18_scaled_model_run$EV_Demand %>%
  mutate(Event_Usage = Oct_16_18_Event_Usage)


graph_table16 <- Oct_16_18_scaled_model_run$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Oct_16_18_scaled_model_run$EV_Demand$MT[1])


Demand_Graph16 <- ggplot(data = graph_table16, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplace Hourly Demand Forecast",
  subtitle="Baseline October 2018 Scaled for October 16th, 2018 Event (494 Chargers) \n Event Usage October 16th, 2018 Event",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph16 <- Demand_Graph16 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph16

ggsave("Oct_16_Event_Usage.pdf", Demand_Graph16, device = "pdf", width = 8, height = 4.5)


#COST
Cost_Table16 <- Oct_16_18_scaled_model_run$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table16)



```



#Scenario 17: September 27, 2018 LR Event + Baseline (scaled for 414 chargers) 

Event: Workplace, September 27, 2018, TOU EV-4, $0.10 Rebate (4PM-9PM)

```{r Scenario 17}

#Scaled Baseline and Oct 16 event usage

#CHARGERS
Sep_27_18_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Sep_27_18_LR) %>%
unlist()

Sep_27_18_scaled_baseline <- hourly_demand(
                    month = 9,
                    year = 2018,
                    seg =  "Workplace",
                    intervention_chargers =
                    Sep_27_18_event,
                    int_equals_baseline = FALSE
                    )


Sep_27_18_Event_Usage <- filter(event_data, Date == "2018-9-27" & segment == "Workplace") %>%
select(Demand) %>%
unlist()


Sep_27_18_scaled_baseline$EV_Demand <- Sep_27_18_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Sep_27_18_Event_Usage)


graph_table17 <- Sep_27_18_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Sep_27_18_scaled_baseline$EV_Demand$MT[1])


Demand_Graph17 <- ggplot(data = graph_table17, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplace Hourly Demand Forecast",
  subtitle="Baseline September 2018 Scaled for September 27th, 2018 LR Event (414 Chargers) \n Event Usage October 16th, 2018 Event",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph17 <- Demand_Graph17 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph17

ggsave("Sep_27_Event_Usage.pdf", Demand_Graph17, device = "pdf", width = 8, height = 4.5)

#Cost
Cost_Table17 <- Sep_27_18_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table17)

```


#Scenario 18: August 30, 2018 LR Event + Baseline (scaled for 442 chargers) 

Event: Workplace, August 30, 2018, TOU EV-4, $0.10 Rebate (4PM-9PM)

```{r Scenario 18}

#Scaled Baseline and Oct 16 event usage

#CHARGERS
Aug_30_18_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Aug_30_18_LR) %>%
unlist()

Aug_30_18_scaled_model_run <- hourly_demand(
                    month = 9,
                    year = 2018,
                    seg =  "Workplace",
                    intervention_chargers =
                    Aug_30_18_event,
                    int_equals_baseline = FALSE
                  )


Aug_30_18_Event_Usage <- filter(event_data, Date == "2018-8-30" & segment == "Workplace") %>%
select(Demand) %>%
unlist()

Aug_30_18_scaled_model_run$EV_Demand <- Aug_30_18_scaled_model_run$EV_Demand %>%
  mutate(Event_Usage = Aug_30_18_Event_Usage)


graph_table18 <- Aug_30_18_scaled_model_run$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Aug_30_18_scaled_model_run$EV_Demand$MT[1])


Demand_Graph18 <- ggplot(data = graph_table18, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplace Hourly Demand Forecast",
  subtitle="Baseline September 2018 Scaled for September 27th, 2018 LR Event (414 Chargers) \n Event Usage October 16th, 2018 Event",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph18 <- Demand_Graph18 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph18

ggsave("Aug_30_Event_Usage.pdf", Demand_Graph18, device = "pdf", width = 8, height = 4.5)

#Cost
Cost_Table18 <- Aug_30_18_scaled_model_run$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table18)

#Sum of Cost
Sum_Cost18 <-sum(Cost_Table18$Cost_diff)
#View(Sum_Cost18)
```



#Scenario 19: July 31, 2018 LR Event + Baseline (scaled for 396 chargers) 

Event: Workplace, July 31, 2018, TOU EV-4, $0.10 Rebate (4PM-9PM)

```{r Scenario 18}

#Scaled Baseline and Oct 16 event usage

#CHARGERS
Jul_31_18_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Jul_31_18_LR) %>%
unlist()

Jul_31_18_scaled_model_run <- hourly_demand(
                    month = 9,
                    year = 2018,
                    seg =  "Workplace",
                    intervention_chargers =
                    Jul_31_18_event,
                    int_equals_baseline = FALSE
                   )


Jul_31_18_Event_Usage <- filter(event_data, Date == "2018-7-31" & segment == "Workplace") %>%
select(Demand) %>%
unlist()


Jul_31_18_scaled_model_run$EV_Demand <- Jul_31_18_scaled_model_run$EV_Demand %>%
  mutate(Event_Usage = Jul_31_18_Event_Usage)


graph_table19 <- Jul_31_18_scaled_model_run$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Jul_31_18_scaled_model_run$EV_Demand$MT[1])


Demand_Graph19 <- ggplot(data = graph_table19, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplace Hourly Demand Forecast",
  subtitle="Baseline September 2018 Scaled for September 27th, 2018 LR Event (414 Chargers) \n Event Usage October 16th, 2018 Event",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph19 <- Demand_Graph19 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph19

ggsave("Jul_31_Event_Usage.pdf", Demand_Graph19, device = "pdf", width = 8, height = 4.5)

#Cost
Cost_Table19 <- Jul_31_18_scaled_model_run$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table19)

#Sum of Cost
Sum_Cost19 <-sum(Cost_Table19$Cost_diff)
#View(Sum_Cost19)
```


#Scenario 20 - Nov 28, 2018 Event + Baseline (scaled for 146 chargers) 

Event: Destination Center, November 28, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 20}

#CHARGERS
nov_28_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Nov_28_18_LS) %>%
unlist()

Nov_28_18_DC_scaled_model_run <- hourly_demand(
                    month = 11,
                    year = 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                    nov_28_18_DC_event,
                    int_equals_baseline = FALSE
                    )


Nov_28_18_DC_Event_Usage <- filter(event_data, Date == "2018-11-28" & segment == "Destination Center") %>%
select(Demand) %>%
unlist()

Nov_28_18_DC_scaled_model_run$EV_Demand <- Nov_28_18_DC_scaled_model_run$EV_Demand %>%
  mutate(Event_Usage = Nov_28_18_DC_Event_Usage)


graph_table20 <- Nov_28_18_DC_scaled_model_run$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Nov_28_18_DC_scaled_model_run$EV_Demand$MT[1])
View(graph_table18)

Demand_Graph20 <- ggplot(data = graph_table18, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Center Hourly Demand Forecast",
  subtitle="Baseline November 2018 Scaled for November 28th, 2018 Event (146 Chargers) \n Event Usage November 28th, 2018 Event",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph20 <- Demand_Graph20 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph20

ggsave("Nov_28_DC_Event_Usage.pdf", Demand_Graph20, device = "pdf", width = 8, height = 4.5)

#Cost
Cost_Table20 <- Nov_28_18_DC_scaled_model_run$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
View(Cost_Table20)

```

#Scenario 21- Nov 14, 2018 EVENT + Baseline (scaled for 117 chargers) 

Event: Destination Center, November 14, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 21}

#Scaled Baseline and Nov 14 event usage

#CHARGERS
nov_14_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Nov_14_18_LS) %>%
unlist()


Nov_14_18_DC_scaled_baseline <- hourly_demand(
                    month = 11,
                    year= 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                    nov_14_18_DC_event,
                    int_equals_baseline = FALSE)



nov_14_18_DC_Event_Usage <- filter(event_data, Date == "2018-11-14" & segment == "Destination Center") %>%
select(Demand) %>%
unlist() 

Nov_14_18_DC_scaled_baseline$EV_Demand <- Nov_14_18_DC_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = nov_14_18_DC_Event_Usage)


graph_table21 <- Nov_14_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Nov_14_18_DC_scaled_baseline$EV_Demand$MT[1])


Demand_Graph21 <- ggplot(data = graph_table21, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Center Hourly Demand Forecast",
  subtitle="November 2018 Baseline Scaled for November 14th, 2018 Event (117 Chargers) \n  November 14th, 2018 Event Usage",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph21 <- Demand_Graph21 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph21

ggsave("Nov_14_DC_Event_Usage.pdf", Demand_Graph21, device = "pdf", width = 8, height = 4.5)

#COST
Cost_Table21 <- Nov_14_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table13)
```

#Scenario 22- Oct 30, 2018 DC EVENT + Baseline (scaled for 150 chargers) 

Event: Destination Center, October 30, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 22}

#Scaled Baseline and Nov 14 event usage

#CHARGERS
Oct_30_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Oct_30_18_LS) %>%
unlist()


Oct_30_18_DC_scaled_baseline <- hourly_demand(
                    month = 10,
                    year= 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                    Oct_30_18_DC_event,
                    int_equals_baseline = FALSE)



Oct_30_18_DC_Event_Usage <- filter(event_data, Date == "2018-10-30" & segment == "Destination Center") %>%
select(Demand) %>%
unlist() 

Oct_30_18_DC_scaled_baseline$EV_Demand <- Oct_30_18_DC_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Oct_30_18_DC_Event_Usage)


graph_table22 <- Oct_30_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Oct_30_18_DC_scaled_baseline$EV_Demand$MT[1])


Demand_Graph22 <- ggplot(data = graph_table22, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Center Hourly Demand Forecast",
  subtitle="Baseline October 2018 Scaled for October 30, 2018 Event (150 Chargers) \n November 14th, 2018 Event Usage",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph22 <- Demand_Graph22 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph22

ggsave("Oct_30_18_DC_Event_Usage.pdf", Demand_Graph22, device = "pdf", width = 8, height = 4.5)

#COST
Cost_Table22 <- Oct_30_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table22)
```

#Scenario 23- Oct 16, 2018 DC EVENT + Baseline (scaled for 110 chargers) 

Event: Destination Center, October 16, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 23}

#Scaled Baseline and October 16 event usage

#CHARGERS
Oct_16_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Oct_16_18_LS) %>%
unlist()


Oct_16_18_DC_scaled_baseline <- hourly_demand(
                    month = 10,
                    year= 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                    Oct_16_18_DC_event,
                    int_equals_baseline = FALSE)



Oct_16_18_DC_Event_Usage <- filter(event_data, Date == "2018-10-16" & segment == "Destination Center") %>%
select(Demand) %>%
unlist() 

Oct_16_18_DC_scaled_baseline$EV_Demand <- Oct_16_18_DC_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Oct_16_18_DC_Event_Usage)


graph_table23 <- Oct_16_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Oct_16_18_DC_scaled_baseline$EV_Demand$MT[1])


Demand_Graph23 <- ggplot(data = graph_table23, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Center Hourly Demand Forecast",
  subtitle="Baseline October 2018 Scaled for October 16, 2018 Event (110 Chargers) \n October 16, 2018 Event Usage",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph23 <- Demand_Graph23 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph23

ggsave("Oct_16_18_DC_Event_Usage.pdf", Demand_Graph23, device = "pdf", width = 8, height = 4.5)

#COST
Cost_Table23 <- Oct_16_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table22)
```

#Scenario 24- Sep 27, 2018 DC EVENT + Baseline (scaled for 176 chargers) 

Event: Destination Center, September 27, 2018, TOU EV-4, $0.10 Rebate (4-9PM)

```{r Scenario 24}

#Scaled Baseline and September 27 event usage

#CHARGERS
Sep_27_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Sep_27_18_LR) %>%
unlist()


Sep_27_18_DC_scaled_baseline <- hourly_demand(
                    month = 9,
                    year= 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                   Sep_27_18_DC_event,
                    int_equals_baseline = FALSE)



Sep_27_18_DC_Event_Usage <- filter(event_data, Date == "2018-9-27" & segment == "Destination Center") %>%
select(Demand) %>%
unlist() 

Sep_27_18_DC_scaled_baseline$EV_Demand <- Sep_27_18_DC_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Sep_27_18_DC_Event_Usage)


graph_table24 <- Sep_27_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Sep_27_18_DC_scaled_baseline$EV_Demand$MT[1])


Demand_Graph24 <- ggplot(data = graph_table24, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Center Hourly Demand Forecast",
  subtitle="September 2018 Baseline Scaled for September 27, 2018 Event (176 Chargers) \n September 27, 2018 Event Usage (Load Reduction)",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph24 <- Demand_Graph24 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph24

ggsave("Sep_27_18_DC_Event_Usage.pdf", Demand_Graph24, device = "pdf", width = 8, height = 4.5)

#COST
Cost_Table24 <- Sep_27_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table24)
```

#Scenario 25- Aug 30, 2018 DC EVENT + Baseline (scaled for 133 chargers) 

Event: Destination Center, August 30, 2018, TOU EV-4, $0.10 Rebate (4-9PM)

```{r Scenario 25}

#Scaled Baseline and September 27 event usage

#CHARGERS
Aug_30_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Aug_30_18_LR) %>%
unlist()


Aug_30_18_DC_scaled_baseline <- hourly_demand(
                    month = 8,
                    year= 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                   Aug_30_18_DC_event,
                    int_equals_baseline = FALSE)



Aug_30_18_DC_Event_Usage <- filter(event_data, Date == "2018-8-30" & segment == "Destination Center") %>%
select(Demand) %>%
unlist() 

Aug_30_18_DC_scaled_baseline$EV_Demand <- Aug_30_18_DC_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Aug_30_18_DC_Event_Usage)


graph_table25 <- Aug_30_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Aug_30_18_DC_scaled_baseline$EV_Demand$MT[1])


Demand_Graph25 <- ggplot(data = graph_table25, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Center Hourly Demand Forecast",
  subtitle="August 2018 Baseline Scaled for August 30, 2018 Event (176 Chargers) \n August 30, 2018 Event Usage (Load Reduction)",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph25 <- Demand_Graph25 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph25

ggsave("Aug_30_18_DC_Event_Usage.pdf", Demand_Graph25, device = "pdf", width = 8, height = 4.5)

#COST
Cost_Table25 <- Aug_30_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table24)
```


#Scenario 26- July 31, 2018 DC EVENT + Baseline (scaled for 172 chargers) 

Event: Destination Center, July 31, 2018, TOU EV-4, $0.10 Rebate (4-9PM)

```{r Scenario 26}

#Scaled Baseline and July 31 event usage

#CHARGERS
Jul_31_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Jul_31_18_LR) %>%
unlist()


Jul_31_18_DC_scaled_baseline <- hourly_demand(
                    month = 7,
                    year= 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                   Jul_31_18_DC_event,
                    int_equals_baseline = FALSE)



Jul_31_18_DC_Event_Usage <- filter(event_data, Date == "2018-7-31" & segment == "Destination Center") %>%
select(Demand) %>%
unlist() 

Jul_31_18_DC_scaled_baseline$EV_Demand <- Jul_31_18_DC_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Jul_31_18_DC_Event_Usage)


graph_table26 <- Jul_31_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Jul_31_18_DC_scaled_baseline$EV_Demand$MT[1])


Demand_Graph26 <- ggplot(data = graph_table26, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Center Hourly Demand Forecast",
  subtitle="July 2018 Baseline Scaled for July 31, 2018 Event (176 Chargers) \n July 31, 2018 Event Usage (Load Reduction)",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph26 <- Demand_Graph26 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph26

ggsave("Jul_31_18_DC_Event_Usage.pdf", Demand_Graph26, device = "pdf", width = 8, height = 4.5)

#COST
Cost_Table26 <- Aug_30_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table24)
```

#Scenario 27 - July 1, 2018 DC EVENT + Baseline (scaled for 146 chargers) 

Event: Destination Center, July 11, 2018, TOU EV-4, $0.10 Rebate (4-9PM)

```{r Scenario 27}

#Scaled Baseline and July 11 event usage

#CHARGERS
Jul_11_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Jul_11_18_LR) %>%
unlist()


Jul_11_18_DC_scaled_baseline <- hourly_demand(
                    month = 7,
                    year= 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                   Jul_11_18_DC_event,
                    int_equals_baseline = FALSE)



Jul_11_18_DC_Event_Usage <- filter(event_data, Date == "2018-7-11" & segment == "Destination Center") %>%
select(Demand) %>%
unlist() 

Jul_11_18_DC_scaled_baseline$EV_Demand <- Jul_11_18_DC_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Jul_11_18_DC_Event_Usage)


graph_table27 <- Jul_11_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Jul_11_18_DC_scaled_baseline$EV_Demand$MT[1])


Demand_Graph27 <- ggplot(data = graph_table27, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Center Hourly Demand Forecast",
  subtitle="July 2018 Baseline Scaled for July 31, 2018 Event (176 Chargers) \n July 31, 2018 Event Usage (Load Reduction)",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph27 <- Demand_Graph27 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph27

ggsave("Jul_11_18_DC_Event_Usage.pdf", Demand_Graph27, device = "pdf", width = 8, height = 4.5)

#COST
Cost_Table27 <- Aug_30_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table24)
```

#WORKPLACE COST TABLES
```{r}
Cost_Table <- rbind(sum(Cost_Table13$Cost_diff), 
                    sum(Cost_Table14$Cost_diff),
                    sum(Cost_Table15$Cost_diff),
                    sum(Cost_Table16$Cost_diff),
                    sum(Cost_Table17$Cost_diff),
                    sum(Cost_Table18$Cost_diff)) %>% 
              mutate()
View(Cost_Table)
```







##Baseline and model with comm SCALED
```{r Scenario 19}
nov_14_18_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Nov_14_18_LS) %>%
unlist()



Nov_14_18_scaled_model_run <- hourly_demand(price_change = -0.05,
                                            throttle_amount = -0.5,
                                            month = "Nov_18",
                                            segment =  "Workplace",
                                            intervention_chargers =
                                            nov_14_18_event,
                                            int_equals_baseline = FALSE,
                                            intervention_comm_effect = 1)




Nov_14_18_scaled_model_run$EV_Demand <- Nov_14_18_scaled_model_run$EV_Demand %>%
  mutate(Event_Usage = nov_14_18_Event_Usage)


graph_table19 <- Nov_14_18_scaled_model_run$EV_Demand[c("Hr","X0","with_comm")] %>%
  gather(condition,value,c("X0","with_comm")) %>%
  mutate(Theoretical_Max=Nov_14_18_scaled_model_run$EV_Demand$MT[1])



Demand_Graph19 <- ggplot(data = graph_table14, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplace Hourly Demand Forecast",
  subtitle="Baseline November 2018 Scaled for November 14th, 2018 Event Number of Chargers \n Modeled $0.05 Discount 11 AM - 3 PM \n Modeled 50% Communication 6 AM - 11 AM \n 80% Reduced Communication Effect",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Modeled Demand", "Scaled Baseline Demand"), values = c( "orange","blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))


Demand_Graph19

ggsave("Model_0.2_comm.pdf", Demand_Graph14, device = "pdf", width = 8, height = 4.5)

```



```{r explore}



# plot of monte carlo output
library(ggplot2)
freq_graph <- ggplot(sim1, aes(x = Hr, y = X0))+
  geom_line(aes(y = Hr_avg)) +
  geom_ribbon(aes(ymin = min, ymax = max))+
  geom_jitter(aes(y = Xf, color = Xf>X0), alpha = 0.5, width = 0.3) +
  geom_line(aes(x = Hr, y = X0), alpha = 0.5, color = "blue")+
  geom_point(aes(x = Hr, y = X0), alpha = 0.5, color = "blue")+
  #geom_ribbon(aes(ymin = min, ymax = max), alpha = 0.5, color ="blue") +
  #geom_line(aes(x = Hr, y = Hr_avg), alpha = 0.5, color = "red")+
  #geom_smooth(model = "lm") +
  theme_minimal() +
  xlab("Hour of the Day") +
  ylab("Charging Demand (kW)") +
  ggtitle("Monte Carlo Simulation of Charging Demand Per Hour")

freq_graph
```


```{r figures}

#need to stack both demand curves in one data frame for a legend
EV_Demand_run1 <- hourly_demand(segment = "Workplace", month = "June_18",intervention_comm_effect = 1, throttle_amount = 0,throttle_hours = c(7:11), price_change = -0.05, intervention_hours = c(12:15))

graph_table <- EV_Demand_run1$EV_Demand[c("Hr","X0","Xf")] %>% 
  gather(condition,value,X0:Xf) %>% 
  mutate(Theoretical_Max=EV_Demand_run1$EV_Demand$MT[1])


Demand_Graph <- ggplot(data = graph_table, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme_classic() +
  labs(title="Hourly Demand Forecast", 
       subtitle="50% Throttling 6 AM - 11 AM",
       y="EV Charging Demand (kW)",
       x="Hour",
       color=NULL) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Demand with Intervention"), values = c("blue", "red")) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  #geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme(plot.subtitle = element_text(hjust = 0.5))+
 theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

Potential_Graph <- Demand_Graph +
  geom_segment(aes(y=Theoretical_Max, yend=Theoretical_Max, x=11, xend=15))
  
# \n 50% Throttling 6 AM - 11 AM label for throttling
# Aesthetic Notes:
# might try to remove space b/w Y-axis and hr0, as well as past hr24
# bold axis titles
# color brewer
# geom_line(aes(y=Theoretical_Max, x=11:15)) +

# If we want to graph the Max Theoretical Segment, we can use this:
# geom_segment(aes(y=Theoretical_Max, yend=Theoretical_Max, x=11, xend=15))


Demand_Graph
Potential_Graph


```

```{r hypothetical_scenarios}

Total_max_theory <- pwr*Chargers$Nov_18[5]
Workplace_max_theory <- pwr*Chargers$Nov_18[4]
MUD_max_theory <- pwr*Chargers$Nov_18[3]
Fleet_max_theory <- pwr*Chargers$Nov_18[2]
DC_max_theory <- pwr*Chargers$Nov_18[1]

Max_theory_table <- Chargers %>% 
  select(Market_Segment, Nov_18) %>% 
  mutate(Theoretical_Max = pwr*Nov_18)

Max_theory_table #This shows the theoretical max per market segment (and total) for the SCE Charge Ready Pilot for ONE hour.

```


